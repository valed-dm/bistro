{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h2>Order Management</h2>
  <div class="d-flex gap-2">
    <button class="btn btn-primary"
            data-bs-target="#addOrderModal"
            data-bs-toggle="modal">Add Order
    </button>
    <button class="btn btn-danger"
            data-bs-target="#deleteOrderModal"
            data-bs-toggle="modal">Delete Order
    </button>
    <button class="btn btn-info"
            data-bs-target="#searchOrderModal"
            data-bs-toggle="modal">Search Order
    </button>
    <button class="btn btn-warning"
            data-bs-target="#updateStatusModal"
            data-bs-toggle="modal">Update Status
    </button>
    <button class="btn btn-success"
            data-bs-target="#totalPaidOrdersModal"
            data-bs-toggle="modal">Total Paid Orders
    </button>
  </div>
  {% if show_search_orders %}
  <div class="container mt-4">
    <h3>Search Results</h3>
    <table class="table">
      <thead>
      <tr>
        <th>ID</th>
        <th>Table Number</th>
        <th>Status</th>
        <th>Created At</th>
        <th>Totals</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      {% for order in orders %}
      <tr>
        <td>{{ order.id }}</td>
        <td>{{ order.table_number }}</td>
        <td>{{ order.status }}</td>
        <td>{{ order.created_at }}</td>
        <td>{{ order.total_order_price }}</td>
        <td>
          <a href="{% url 'orders:order_detail' order.id %}">View Details</a>
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    <button class="btn btn-info"
            onclick="window.location.href='{% url 'orders:manager' %}'"
            type="button">
      Drop Search
      Mode
    </button>
  </div>
  {% endif %}
  {% if total_paid is not None %}
  <div class="alert alert-success mt-3">
    <strong>Total Paid Orders Sum:</strong> ${{ total_paid }}
  </div>
  {% endif %}
  {% for modal in modals %}
  <div class="modal fade" id="{{ modal.id }}" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ modal.title }}</h5>
          <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
        </div>
        <div class="modal-body">
          <form method="post">
            {% csrf_token %}
            {{ modal.form.as_p }}
            <input id="quantities-input" name="quantities" type="hidden"/>
            <button class="btn btn-primary"
                    name="{{ modal.id|slice:-5|lower }}"
                    type="submit">Submit
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock content %}
{% block inline_javascript %}
<script>
  document.querySelectorAll('input[name="items"]').forEach((checkbox) => {
    checkbox.addEventListener("change", function() {
      let quantities = JSON.parse(document.getElementById("quantities-input").value || "{}");
      if (this.checked) {
        let qty = prompt(`Enter quantity for ${this.dataset.itemName}:`, "1");
        if (qty && !isNaN(qty) && qty > 0) {
          quantities[this.value] = qty;
        } else {
          this.checked = false;
        }
      } else {
        delete quantities[this.value];
      }
      document.getElementById("quantities-input").value = JSON.stringify(quantities);
    });
  });
</script>
{% endblock inline_javascript %}
